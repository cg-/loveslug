{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout.html'}}

<body class="background">
<div class="container-fluid">

    <div class="row">
        <div class="col-md-4">
        </div>
        <div class="title col-md-4" style="width:100%">
            <!-- PAGE HEADER -->
            <center>
                <h3>
                    {{=thisprofile[-1].your_name}}'s Profile
                </h3>
                <h5>
                    <div id="message-box" style="width:75%"></div>
                    <hr>
                </h5>
                <div>
                    <h4><b>{{=thisprofile[-1].your_name}}'s Picture:</b></h4>
                    <span><img src="{{=URL('default', 'download', args=thisprofile[-1].image)}}" alt="Profile Picture" style="width:150px;height:150px;"/></span>
                    <h4><b>Name:</b></h4>
                    <span><h5>{{=thisprofile[-1].your_name}}</h5></span>
                    <h4><b>Birthday:</b></h4>
                    <span><h5>{{=thisprofile[-1].birthday}}</h5></span>
                    <h4><b>Gender:</b></h4>
                    <span><h5>{{=thisprofile[-1].gender}}</h5></span>
                    <h4><b>About Me:</b></h4>
                    <span><h5>{{=(thisprofile[-1].about_me)}}</h5></span>
                    <h4><b>Interests:</b></h4>
                    <span><h5>{{=thisprofile[-1].interests}}</h5></span>
                    <h4><b>Major:</b></h4>
                    <span><h5>{{=thisprofile[-1].major}}</h5></span>
                    <h4><b>Location:</b></h4>
                    <span><h5>{{=thisprofile[-1].college}}</h5></span>
                {{pass}}

                    <!-- TIPS -->

                    <h1> . </h1>
                </div>
                <div class="col-md-4">
                </div>
            </center>
        </div>
    </div>
</div>
</body>

<script id="message-template" type="text/ractive">
    <button on-click="clicked-message" style="background-color: transparent;color: white">Message {{=thisprofile[-1].your_name}}</button>
    {% #if show_message_edit %}
    <h2>Send a Message</h2>
    <table style="width: 100%">
        <tr>
            <td>
                Subject:
            </td>
            <td>
                <textarea on-blur="update-subject" id="subject-field" rows=1 style="width: 100%; background-color: transparent; color: white"></textarea>
            </td>
        </tr>
        <tr>
            <td>
                Body:
            </td>
            <td>
                <textarea on-blur="update-text" id="text-field" rows=18 style="width: 100%; background-color: transparent; color: white"></textarea>
            </td>
        </tr>
    </table>
    <br />
    <button on-click="send-reply" style="background-color: transparent;color: white">
    Send
    </button>
    <br />
    <br />
    <button on-click="back" style="background-color: transparent;color: white">
    Back
    </button>
    {% /if %}
</script>

<script>
    $(function() {
        // Ractive object
        var RACTIVE = new Ractive({
            el: '#message-box',
            template: '#message-template',
            delimiters: ['{%', '%}'],
            tripleDelimiters: ['{%%', '%%}'],
            data: {
                show_message_edit: false,
                text: '',
                subject: ''
            },
        });

        RACTIVE.on("clicked-message", function(e){
            RACTIVE.set('show_message_edit', true);
        });

        RACTIVE.on("update-text", function(e){
            RACTIVE.set('text', e.node.value);
        });

        RACTIVE.on("update-subject", function(e){
            RACTIVE.set('subject', e.node.value);
        });

        RACTIVE.on("send-reply", function(e){
            var to = Number({{=thisprofile[-1].user_id}});
            var subject = RACTIVE.get('subject');
            var body = RACTIVE.get('text');
            sendMessage(to, subject, body);
            RACTIVE.set('text', '');
            RACTIVE.set('subject', '');
            RACTIVE.set('show_message_edit', false);
        });

        RACTIVE.on("back", function(e){
            RACTIVE.set('text', '');
            RACTIVE.set('subject', '');
            RACTIVE.set('show_message_edit', false);
        });

        var sendMessage = function(rec, subject, body){
            $.ajax("{{=URL('default', 'send_message', user_signature=True)}}",
                    {
                        data: {
                            message_id: generateUUID(),
                            receiver: rec, // request.vars.msg
                            body: body, // request.vars.is_draft
                            subject: subject // request.vars.msg_id
                        },
                        method: 'POST',
                        success: function() {
                        },
                        error: function() {}
                    }
            );
        };

        // http://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
        function generateUUID(){
            var d = new Date().getTime();
            if(window.performance && typeof window.performance.now === "function"){
                d += performance.now();; //use high-precision timer if available
            }
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = (d + Math.random()*16)%16 | 0;
                d = Math.floor(d/16);
                return (c=='x' ? r : (r&0x3|0x8)).toString(16);
            });
            return uuid;
        }
    });

</script>
